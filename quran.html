<!DOCTYPE html>
<html lang="fr" dir="ltr">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"/>
<title>Al-Quran â€” Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ…</title>
<meta name="description" content="Lisez et Ã©coutez le Saint Coran"/>
<meta name="theme-color" content="#0a0d14"/>
<link rel="manifest" href="manifest.json"/>
<link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Cinzel:wght@400;600;700&family=Lato:wght@300;400;700&display=swap" rel="stylesheet"/>
<link rel="stylesheet" href="style.css"/>
</head>
<body>

<div class="bg-glow"></div>
<div class="bg-pattern">
  <svg viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="xMidYMid slice">
    <defs><pattern id="geo" x="0" y="0" width="40" height="40" patternUnits="userSpaceOnUse">
      <polygon points="20,2 38,11 38,29 20,38 2,29 2,11" fill="none" stroke="#c9a84c" stroke-width="0.5"/>
      <polygon points="20,8 32,14 32,26 20,32 8,26 8,14" fill="none" stroke="#c9a84c" stroke-width="0.3"/>
    </pattern></defs>
    <rect width="200" height="200" fill="url(#geo)"/>
  </svg>
</div>

<div class="loading-overlay" id="loading">
  <div class="spinner"></div>
  <div class="loading-text" id="loading-msg">ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ…...</div>
</div>

<div class="toast" id="toast"></div>

<!-- VIEW: BROWSE -->
<div id="view-browse">
  <div class="section-header">
    <a href="index.html" class="sec-back">â† Accueil</a>
    <div class="sec-title-area">
      <div class="sec-title">Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ…</div>
      <div class="sec-subtitle">Le Noble Coran</div>
    </div>
    <div class="sec-actions">
      <button onclick="openSettings()" title="ParamÃ¨tres">âš™ï¸</button>
    </div>
  </div>

  <div class="quran-progress">
    <span class="progress-label">Progression</span>
    <div class="progress-bar-wrap"><div class="progress-bar-fill" id="progressFill"></div></div>
    <span class="progress-count" id="progressCount">0/30</span>
  </div>

  <div class="quran-tabs">
    <button class="tab-btn active" id="tab-juz" onclick="switchTab('juz')">ğŸ“– Par Juz</button>
    <button class="tab-btn" id="tab-surah" onclick="switchTab('surah')">ğŸ“‹ Par Sourate</button>
  </div>

  <div class="grid-wrap" id="juz-section"><div class="grid" id="juz-grid"></div></div>
  <div class="surah-wrap" id="surah-section">
    <div class="search-wrap">
      <span class="search-icon">ğŸ”</span>
      <input class="search-input" type="text" placeholder="Rechercher une sourate..." oninput="filterSurahs(this.value)"/>
    </div>
    <div id="surah-list"></div>
  </div>
</div>

<!-- VIEW: READER -->
<div id="view-reader" style="display:none;">
  <div class="section-header">
    <button class="sec-back" onclick="goBack()">â† Retour</button>
    <div class="sec-title-area">
      <div class="sec-title" id="reader-title"></div>
      <div class="sec-subtitle" id="reader-subtitle"></div>
    </div>
    <div class="sec-actions">
      <button onclick="toggleTranslation()" id="btn-trans" class="on" title="Traduction">ğŸŒ</button>
      <button onclick="openSettings()" title="ParamÃ¨tres">âš™ï¸</button>
    </div>
  </div>
  <div class="reader-content" id="reader-content"></div>
  <div id="reader-nav"></div>
</div>

<!-- AUDIO PLAYER -->
<div class="audio-player" id="audio-player">
  <div class="player-progress" id="player-progress" onclick="seekAudio(event)">
    <div class="player-progress-fill" id="player-progress-fill"></div>
  </div>
  <div class="player-main">
    <div class="player-info">
      <div class="player-surah-name" id="player-surah">â€”</div>
      <div class="player-ayah-num" id="player-ayah">â€”</div>
    </div>
    <div class="player-controls">
      <button onclick="prevAyah()">â®</button>
      <button class="play-main" onclick="togglePlay()" id="play-btn">â–¶</button>
      <button onclick="nextAyah()">â­</button>
    </div>
    <div class="player-extra">
      <button onclick="toggleRepeat()" id="btn-repeat">ğŸ”</button>
      <button onclick="toggleAutoplay()" id="btn-autoplay" class="on">â©</button>
    </div>
  </div>
</div>

<!-- SETTINGS -->
<div class="settings-overlay" id="settings-overlay" onclick="if(event.target===this)closeSettings()">
  <div class="settings-panel">
    <div class="settings-handle"></div>
    <div class="settings-title">âš™ï¸ ParamÃ¨tres</div>
    <div class="setting-group">
      <label class="setting-label">ğŸ™ï¸ RÃ©citateur</label>
      <select class="setting-select" id="select-reciter" onchange="changeReciter(this.value)">
        <option value="ar.alafasy">Mishary Rashid Alafasy</option>
        <option value="ar.abdulbasitmurattal">Abdul Basit (Murattal)</option>
        <option value="ar.abdurrahmaansudais">Abdurrahman As-Sudais</option>
        <option value="ar.husary">Mahmoud Khalil Al-Husary</option>
        <option value="ar.minshawimujawwad">El-Minshawi (Mujawwad)</option>
        <option value="ar.hudhaify">Ali Al-Hudhaify</option>
        <option value="ar.muhammadayyoub">Muhammad Ayyoub</option>
        <option value="ar.muhammadjibreel">Muhammad Jibreel</option>
        <option value="ar.hanirifai">Hani Ar-Rifai</option>
        <option value="ar.ibrahimakhdar">Ibrahim Al-Akhdar</option>
      </select>
    </div>
    <div class="setting-group">
      <label class="setting-label">ğŸŒ Traduction</label>
      <select class="setting-select" id="select-translation" onchange="changeTranslation(this.value)">
        <option value="fr.hamidullah">ğŸ‡«ğŸ‡· FranÃ§ais â€” Hamidullah</option>
        <option value="en.sahih">ğŸ‡¬ğŸ‡§ English â€” Sahih International</option>
        <option value="en.pickthall">ğŸ‡¬ğŸ‡§ English â€” Pickthall</option>
      </select>
    </div>
    <button class="settings-close" onclick="closeSettings()">âœ“ Fermer</button>
  </div>
</div>

<audio id="quran-audio" preload="auto"></audio>

<script>
/* ================================================================
   STATE
   ================================================================ */
var S = {
  currentView: 'browse',
  type: null, num: null,
  ayahs: [], trans: [],
  audioUrls: [],          // Audio URLs from API
  idx: 0,
  playing: false, repeat: false, autoplay: true, showTrans: true,
  reciter: localStorage.getItem('q_rec') || 'ar.alafasy',
  edition: localStorage.getItem('q_tr') || 'fr.hamidullah',
  done: JSON.parse(localStorage.getItem('q_done') || '[]'),
  surahList: null, cache: {}
};

var API = 'https://api.alquran.cloud/v1';
var audio = document.getElementById('quran-audio');

var JUZ_AR = [
  'Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø£ÙˆÙ„','Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø«Ø§Ù†ÙŠ','Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø«Ø§Ù„Ø«','Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø±Ø§Ø¨Ø¹','Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø®Ø§Ù…Ø³',
  'Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø³Ø§Ø¯Ø³','Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø³Ø§Ø¨Ø¹','Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø«Ø§Ù…Ù†','Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„ØªØ§Ø³Ø¹','Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø¹Ø§Ø´Ø±',
  'Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø­Ø§Ø¯ÙŠ Ø¹Ø´Ø±','Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø«Ø§Ù†ÙŠ Ø¹Ø´Ø±','Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø«Ø§Ù„Ø« Ø¹Ø´Ø±','Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø±Ø§Ø¨Ø¹ Ø¹Ø´Ø±','Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø®Ø§Ù…Ø³ Ø¹Ø´Ø±',
  'Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø³Ø§Ø¯Ø³ Ø¹Ø´Ø±','Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø³Ø§Ø¨Ø¹ Ø¹Ø´Ø±','Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø«Ø§Ù…Ù† Ø¹Ø´Ø±','Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„ØªØ§Ø³Ø¹ Ø¹Ø´Ø±','Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø¹Ø´Ø±ÙˆÙ†',
  'Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø­Ø§Ø¯ÙŠ ÙˆØ§Ù„Ø¹Ø´Ø±ÙˆÙ†','Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø«Ø§Ù†ÙŠ ÙˆØ§Ù„Ø¹Ø´Ø±ÙˆÙ†','Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø«Ø§Ù„Ø« ÙˆØ§Ù„Ø¹Ø´Ø±ÙˆÙ†','Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø±Ø§Ø¨Ø¹ ÙˆØ§Ù„Ø¹Ø´Ø±ÙˆÙ†','Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø®Ø§Ù…Ø³ ÙˆØ§Ù„Ø¹Ø´Ø±ÙˆÙ†',
  'Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø³Ø§Ø¯Ø³ ÙˆØ§Ù„Ø¹Ø´Ø±ÙˆÙ†','Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø³Ø§Ø¨Ø¹ ÙˆØ§Ù„Ø¹Ø´Ø±ÙˆÙ†','Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø«Ø§Ù…Ù† ÙˆØ§Ù„Ø¹Ø´Ø±ÙˆÙ†','Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„ØªØ§Ø³Ø¹ ÙˆØ§Ù„Ø¹Ø´Ø±ÙˆÙ†','Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø«Ù„Ø§Ø«ÙˆÙ†'
];

/* ================================================================
   UTILS
   ================================================================ */
function toAr(n){var d='Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©';return String(n).split('').map(function(c){return d[+c]||c;}).join('');}
function showLoading(m){document.getElementById('loading-msg').textContent=m||'ØªØ­Ù…ÙŠÙ„...';document.getElementById('loading').classList.add('show');}
function hideLoading(){document.getElementById('loading').classList.remove('show');}
function showToast(m){var t=document.getElementById('toast');t.textContent=m;t.classList.add('show');setTimeout(function(){t.classList.remove('show');},3000);}

/* ================================================================
   VIEW MANAGEMENT
   ================================================================ */
function showBrowse(){document.getElementById('view-browse').style.display='';document.getElementById('view-reader').style.display='none';S.currentView='browse';window.scrollTo(0,0);}
function showReader(){document.getElementById('view-browse').style.display='none';document.getElementById('view-reader').style.display='';S.currentView='reader';window.scrollTo(0,0);}
function goBack(){audio.pause();S.playing=false;updatePlayBtn();document.getElementById('audio-player').classList.remove('show');showBrowse();}

/* ================================================================
   PROGRESS
   ================================================================ */
function saveDone(){localStorage.setItem('q_done',JSON.stringify(S.done));updateProgress();}
function updateProgress(){var n=S.done.length;document.getElementById('progressFill').style.width=(n/30*100)+'%';document.getElementById('progressCount').textContent=n+'/30';}
function toggleDone(num,e){e.stopPropagation();var i=S.done.indexOf(num);if(i===-1){S.done.push(num);showToast('âœ“ Juz '+num+' marquÃ© lu');}else S.done.splice(i,1);saveDone();renderJuzGrid();}

/* ================================================================
   API
   ================================================================ */
function apiFetch(endpoint){
  return fetch(API+endpoint).then(function(r){
    if(!r.ok)throw new Error('HTTP '+r.status);
    return r.json();
  }).then(function(j){
    if(j.code!==200)throw new Error('API '+j.code);
    return j.data;
  });
}

/* ================================================================
   LOAD JUZ â€” Now fetches audio URLs from API!
   ================================================================ */
function loadJuz(num){
  var key='juz_'+num+'_'+S.edition+'_'+S.reciter;
  if(S.cache[key])return Promise.resolve(S.cache[key]);

  showLoading('ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¬Ø²Ø¡ '+toAr(num)+'...');
  return Promise.all([
    apiFetch('/juz/'+num+'/quran-uthmani'),       // Arabic text
    apiFetch('/juz/'+num+'/'+S.edition),            // Translation
    apiFetch('/juz/'+num+'/'+S.reciter)             // Audio (with URLs!)
  ]).then(function(results){
    var result={
      ayahs: results[0].ayahs,
      trans: results[1].ayahs,
      audioUrls: results[2].ayahs.map(function(a){return a.audio;})
    };
    S.cache[key]=result;
    hideLoading();
    return result;
  }).catch(function(err){
    hideLoading();
    throw err;
  });
}

/* ================================================================
   LOAD SURAH â€” Now fetches audio URLs from API!
   ================================================================ */
function loadSurah(num){
  var key='surah_'+num+'_'+S.edition+'_'+S.reciter;
  if(S.cache[key])return Promise.resolve(S.cache[key]);

  showLoading('ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³ÙˆØ±Ø©...');
  return Promise.all([
    apiFetch('/surah/'+num+'/quran-uthmani'),
    apiFetch('/surah/'+num+'/'+S.edition),
    apiFetch('/surah/'+num+'/'+S.reciter)           // Audio!
  ]).then(function(results){
    var ar=results[0];
    var tr=results[1];
    var au=results[2];

    // Inject surah info
    var info={number:ar.number,name:ar.name,englishName:ar.englishName,
      englishNameTranslation:ar.englishNameTranslation,
      numberOfAyahs:ar.numberOfAyahs,revelationType:ar.revelationType};
    ar.ayahs.forEach(function(a){a.surah=info;});
    tr.ayahs.forEach(function(a){a.surah=info;});

    var result={
      ayahs:ar.ayahs,
      trans:tr.ayahs,
      audioUrls:au.ayahs.map(function(a){return a.audio;})
    };
    S.cache[key]=result;
    hideLoading();
    return result;
  }).catch(function(err){
    hideLoading();
    throw err;
  });
}

function loadSurahList(){
  if(S.surahList)return Promise.resolve(S.surahList);
  return apiFetch('/surah').then(function(d){S.surahList=d;return d;});
}

/* ================================================================
   OPEN JUZ / SURAH
   ================================================================ */
function openJuz(num){
  showReader();S.type='juz';S.num=num;
  document.getElementById('reader-title').textContent=JUZ_AR[num-1];
  document.getElementById('reader-subtitle').textContent='Juz '+num+' / 30';
  document.getElementById('reader-content').innerHTML=loadingHTML();
  document.getElementById('reader-nav').innerHTML='';

  loadJuz(num).then(function(data){
    S.ayahs=data.ayahs;S.trans=data.trans;S.audioUrls=data.audioUrls;S.idx=0;
    renderVerses();renderNav();
  }).catch(function(){
    document.getElementById('reader-content').innerHTML=errorHTML('openJuz('+num+')');
  });
}

function openSurah(num){
  showReader();S.type='surah';S.num=num;
  document.getElementById('reader-subtitle').textContent='Sourate '+num+' / 114';
  document.getElementById('reader-content').innerHTML=loadingHTML();
  document.getElementById('reader-nav').innerHTML='';

  loadSurah(num).then(function(data){
    S.ayahs=data.ayahs;S.trans=data.trans;S.audioUrls=data.audioUrls;S.idx=0;
    document.getElementById('reader-title').textContent=data.ayahs[0].surah.name;
    renderVerses();renderNav();
  }).catch(function(){
    document.getElementById('reader-content').innerHTML=errorHTML('openSurah('+num+')');
  });
}

function loadingHTML(){return '<div style="text-align:center;padding:80px 20px"><div class="spinner" style="margin:0 auto 16px"></div><div style="font-family:Amiri,serif;color:var(--gold);font-size:1.1rem">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div></div>';}
function errorHTML(fn){return '<div style="text-align:center;padding:60px 20px"><div style="font-size:3rem;margin-bottom:16px">âŒ</div><h3 style="color:#e74c3c;font-family:Cinzel,serif;margin-bottom:8px">Erreur de chargement</h3><p style="color:var(--text-dim);margin-bottom:20px;font-size:.88rem">VÃ©rifiez votre connexion internet</p><button onclick="'+fn+'" style="background:var(--gold);color:var(--night);border:none;padding:12px 28px;border-radius:10px;font-weight:700;cursor:pointer">ğŸ”„ RÃ©essayer</button></div>';}

/* ================================================================
   RENDER: JUZ GRID
   ================================================================ */
function renderJuzGrid(){
  var grid=document.getElementById('juz-grid');grid.innerHTML='';
  for(var i=1;i<=30;i++){
    (function(num){
      var done=S.done.includes(num);
      var card=document.createElement('div');
      card.className='juz-card'+(done?' completed':'');
      card.style.animationDelay=Math.min(num,15)*0.03+'s';
      card.innerHTML='<span class="juz-arabic">'+JUZ_AR[num-1].split(' ').slice(0,2).join(' ')+'</span><span class="juz-label">Juz</span><span class="juz-number">'+String(num).padStart(2,'0')+'</span><span class="listen-badge">ğŸ“– Lire</span><button class="mark-btn" onclick="toggleDone('+num+',event)">'+(done?'âœ“ TerminÃ©':'+ Lu')+'</button>';
      card.addEventListener('click',function(){openJuz(num);});
      grid.appendChild(card);
    })(i);
  }
  updateProgress();
}

/* ================================================================
   RENDER: SURAH LIST
   ================================================================ */
var surahRendered=false;
function renderSurahList(){
  if(surahRendered)return;
  var c=document.getElementById('surah-list');
  c.innerHTML='<div style="text-align:center;padding:30px;color:var(--text-dim)"><div class="spinner" style="margin:0 auto 10px"></div>Chargement...</div>';
  loadSurahList().then(function(surahs){
    c.innerHTML='';
    surahs.forEach(function(s){
      var item=document.createElement('div');item.className='surah-item';
      item.dataset.search=(s.name+' '+s.englishName+' '+s.englishNameTranslation+' '+s.number).toLowerCase();
      item.innerHTML='<div class="surah-num">'+s.number+'</div><div class="surah-info"><div class="surah-name-ar">'+s.name+'</div><div class="surah-name-en">'+s.englishName+' â€” '+s.englishNameTranslation+'</div></div><div class="surah-meta"><div class="surah-ayah-count">'+s.numberOfAyahs+' v.</div><div class="surah-type">'+(s.revelationType==='Meccan'?'ğŸ•‹ Mecquoise':'ğŸ•Œ MÃ©dinoise')+'</div></div>';
      item.addEventListener('click',function(){openSurah(s.number);});
      c.appendChild(item);
    });
    surahRendered=true;
  }).catch(function(){
    c.innerHTML='<div style="text-align:center;padding:30px;color:#e74c3c">Erreur <button onclick="surahRendered=false;renderSurahList()" style="color:var(--gold);background:none;border:1px solid var(--gold);padding:6px 14px;border-radius:8px;margin-top:8px;cursor:pointer">RÃ©essayer</button></div>';
  });
}

function filterSurahs(q){q=q.toLowerCase().trim();var items=document.querySelectorAll('.surah-item');for(var i=0;i<items.length;i++)items[i].style.display=(!q||items[i].dataset.search.indexOf(q)!==-1)?'':'none';}

function switchTab(tab){
  document.getElementById('tab-juz').classList.toggle('active',tab==='juz');
  document.getElementById('tab-surah').classList.toggle('active',tab==='surah');
  document.getElementById('juz-section').style.display=tab==='juz'?'':'none';
  var se=document.getElementById('surah-section');
  if(tab==='surah'){se.classList.add('active');renderSurahList();}else se.classList.remove('active');
}

/* ================================================================
   RENDER: VERSES
   ================================================================ */
function renderVerses(){
  var content=document.getElementById('reader-content');content.innerHTML='';
  var curSurah=null;
  S.ayahs.forEach(function(ayah,idx){
    if(!curSurah||ayah.surah.number!==curSurah){
      curSurah=ayah.surah.number;
      var banner=document.createElement('div');banner.className='surah-banner';
      banner.innerHTML='<div class="surah-banner-name">'+ayah.surah.name+'</div><div class="surah-banner-en">'+ayah.surah.englishName+'</div><div class="surah-banner-detail">'+ayah.surah.englishNameTranslation+' â€¢ '+ayah.surah.numberOfAyahs+' versets â€¢ '+(ayah.surah.revelationType==='Meccan'?'ğŸ•‹ Mecquoise':'ğŸ•Œ MÃ©dinoise')+'</div>';
      content.appendChild(banner);
      if(ayah.surah.number!==9&&ayah.surah.number!==1){var bis=document.createElement('div');bis.className='bismillah';bis.textContent='Ø¨ÙØ³Ù’Ù…Ù Ù±Ù„Ù„ÙÙ‘Ù‡Ù Ù±Ù„Ø±ÙÙ‘Ø­Ù’Ù…ÙÙ°Ù†Ù Ù±Ù„Ø±ÙÙ‘Ø­ÙÙŠÙ…Ù';content.appendChild(bis);}
    }
    var verse=document.createElement('div');verse.className='verse';verse.id='v-'+idx;
    var html='<div class="verse-head"><span class="verse-num-badge">'+toAr(ayah.numberInSurah)+'</span><button class="verse-play-btn" id="vb-'+idx+'" onclick="event.stopPropagation();playAyah('+idx+')">â–¶ Ã‰couter</button></div><div class="verse-arabic">'+ayah.text+' ï´¿'+toAr(ayah.numberInSurah)+'ï´¾</div>';
    if(S.showTrans&&S.trans[idx])html+='<div class="verse-translation">'+S.trans[idx].text+'</div>';
    verse.innerHTML=html;
    verse.addEventListener('click',function(){playAyah(idx);});
    content.appendChild(verse);
  });
  var spacer=document.createElement('div');spacer.style.height='130px';content.appendChild(spacer);
  document.getElementById('audio-player').classList.add('show');
}

function renderNav(){
  var el=document.getElementById('reader-nav');
  if(S.type==='juz'){
    el.innerHTML='<div class="nav-buttons"><button class="nav-btn" onclick="openJuz('+(S.num-1)+')"'+(S.num<=1?' disabled':'')+'>â† Juz prÃ©c.</button><button class="nav-btn" onclick="openJuz('+(S.num+1)+')"'+(S.num>=30?' disabled':'')+'>Juz suiv. â†’</button></div>';
  }else{
    el.innerHTML='<div class="nav-buttons"><button class="nav-btn" onclick="openSurah('+(S.num-1)+')"'+(S.num<=1?' disabled':'')+'>â† Sourate prÃ©c.</button><button class="nav-btn" onclick="openSurah('+(S.num+1)+')"'+(S.num>=114?' disabled':'')+'>Sourate suiv. â†’</button></div>';
  }
}

/* ================================================================
   AUDIO â€” Now uses API URLs (guaranteed to work!)
   ================================================================ */
function playAyah(idx){
  if(idx<0||idx>=S.ayahs.length)return;
  S.idx=idx;

  // Use the URL from the API â€” this ALWAYS works!
  var url=S.audioUrls[idx];
  if(!url){
    showToast('âš ï¸ Audio non disponible pour ce verset');
    return;
  }

  audio.src=url;
  audio.play().then(function(){
    S.playing=true;updatePlayBtn();
  }).catch(function(){
    showToast('âš ï¸ Erreur de lecture audio');
  });

  highlightVerse(idx);
  updatePlayerInfo();
  document.getElementById('audio-player').classList.add('show');
}

function togglePlay(){
  if(!S.ayahs.length)return;
  if(S.playing){audio.pause();S.playing=false;}
  else{
    if(!audio.src||audio.src===location.href){playAyah(0);return;}
    audio.play().catch(function(){});S.playing=true;
  }
  updatePlayBtn();
}

function nextAyah(){if(S.idx<S.ayahs.length-1)playAyah(S.idx+1);}
function prevAyah(){if(S.idx>0)playAyah(S.idx-1);}
function toggleRepeat(){S.repeat=!S.repeat;document.getElementById('btn-repeat').classList.toggle('on',S.repeat);showToast(S.repeat?'ğŸ” RÃ©pÃ©tition activÃ©e':'ğŸ” DÃ©sactivÃ©e');}
function toggleAutoplay(){S.autoplay=!S.autoplay;document.getElementById('btn-autoplay').classList.toggle('on',S.autoplay);}
function updatePlayBtn(){document.getElementById('play-btn').textContent=S.playing?'â¸':'â–¶';}

function updatePlayerInfo(){
  if(S.ayahs[S.idx]){
    var a=S.ayahs[S.idx];
    document.getElementById('player-surah').textContent=a.surah.name+' â€” '+a.surah.englishName;
    document.getElementById('player-ayah').textContent='Verset '+a.numberInSurah+' / '+a.surah.numberOfAyahs;
  }
}

function highlightVerse(idx){
  var old=document.querySelectorAll('.verse.playing');for(var i=0;i<old.length;i++)old[i].classList.remove('playing');
  var oldB=document.querySelectorAll('.verse-play-btn.active-v');for(var j=0;j<oldB.length;j++){oldB[j].classList.remove('active-v');oldB[j].textContent='â–¶ Ã‰couter';}
  var el=document.getElementById('v-'+idx);if(el){el.classList.add('playing');el.scrollIntoView({behavior:'smooth',block:'center'});}
  var btn=document.getElementById('vb-'+idx);if(btn){btn.classList.add('active-v');btn.textContent='â¸ En cours';}
}

function seekAudio(e){var bar=document.getElementById('player-progress');var pct=e.offsetX/bar.offsetWidth;if(audio.duration)audio.currentTime=pct*audio.duration;}

audio.addEventListener('timeupdate',function(){if(audio.duration)document.getElementById('player-progress-fill').style.width=(audio.currentTime/audio.duration*100)+'%';});
audio.addEventListener('ended',function(){
  if(S.repeat){audio.currentTime=0;audio.play().catch(function(){});}
  else if(S.autoplay&&S.idx<S.ayahs.length-1)playAyah(S.idx+1);
  else{S.playing=false;updatePlayBtn();var b=document.getElementById('vb-'+S.idx);if(b){b.classList.remove('active-v');b.textContent='â–¶ Ã‰couter';}}
});
audio.addEventListener('error',function(){showToast('âš ï¸ Erreur audio');S.playing=false;updatePlayBtn();});

/* ================================================================
   TRANSLATION / SETTINGS
   ================================================================ */
function toggleTranslation(){
  S.showTrans=!S.showTrans;
  document.getElementById('btn-trans').classList.toggle('on',S.showTrans);
  showToast(S.showTrans?'ğŸŒ Traduction affichÃ©e':'ğŸŒ Traduction masquÃ©e');
  if(S.currentView==='reader'&&S.ayahs.length)renderVerses();
}

function openSettings(){document.getElementById('settings-overlay').classList.add('show');}
function closeSettings(){document.getElementById('settings-overlay').classList.remove('show');}

function changeReciter(val){
  S.reciter=val;
  localStorage.setItem('q_rec',val);
  S.cache={};  // Clear cache to refetch with new reciter
  showToast('ğŸ™ï¸ RÃ©citateur changÃ© â€” rechargement...');
  closeSettings();
  // Reload current content with new reciter
  if(S.currentView==='reader'&&S.num){
    if(S.type==='juz')openJuz(S.num);
    else openSurah(S.num);
  }
}

function changeTranslation(val){
  S.edition=val;
  localStorage.setItem('q_tr',val);
  S.cache={};
  showToast('ğŸŒ Traduction changÃ©e â€” rechargement...');
  closeSettings();
  if(S.currentView==='reader'&&S.num){
    if(S.type==='juz')openJuz(S.num);
    else openSurah(S.num);
  }
}

/* ================================================================
   KEYBOARD
   ================================================================ */
document.addEventListener('keydown',function(e){
  if(e.target.tagName==='INPUT')return;
  if(S.currentView==='reader'){
    if(e.code==='Space'){e.preventDefault();togglePlay();}
    if(e.key==='ArrowRight')nextAyah();
    if(e.key==='ArrowLeft')prevAyah();
  }
  if(e.key==='Escape'&&S.currentView==='reader')goBack();
});

/* ================================================================
   URL PARAMS
   ================================================================ */
function checkParams(){
  var params=new URLSearchParams(window.location.search);
  var juz=params.get('juz');var surah=params.get('surah');
  if(juz&&+juz>=1&&+juz<=30)openJuz(+juz);
  else if(surah&&+surah>=1&&+surah<=114)openSurah(+surah);
}

/* ================================================================
   INIT
   ================================================================ */
(function(){
  document.getElementById('select-reciter').value=S.reciter;
  document.getElementById('select-translation').value=S.edition;
  document.getElementById('btn-trans').classList.toggle('on',S.showTrans);
  document.getElementById('btn-autoplay').classList.toggle('on',S.autoplay);
  renderJuzGrid();
  checkParams();
})();
</script>
</body>
</html>
